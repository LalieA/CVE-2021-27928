# Inspired from official MariaDB Dockerfiles
# https://github.com/MariaDB/mariadb-docker/blob/master/Dockerfile.template
# https://mariadb.com/kb/en/creating-a-custom-docker-image/

FROM mariadb:10.4.12

RUN apt-get update && \
    # setting up openssh-server to be able to scp files and supervisor to execute multiple services
    apt-get -y install openssh-server supervisor && \
    mkdir /var/run/sshd && \
    # no root login allowed over ssh
    sed -i 's/PermitRootLogin prohibit-password/PermitRootLogin no/' /etc/ssh/sshd_config && \
    # adding a non-root system user
    adduser --system --home /home/myuser --shell /bin/bash myuser && \
    echo "myuser:mypassword" | chpasswd && \
    # ssh login fix, otherwise we'll be kicked off after login
    sed 's@session\s*required\s*pam_loginuid.so@session optional pam_loginuid.so@g' -i /etc/pam.d/sshd && \
    echo 'export NOTVISIBLE="in users profile"' >> /home/myuser/.bashrc && \
    echo "export VISIBLE=now" >> /etc/profile && \
	rm -rf /var/lib/apt/lists/* && \
    # setting our target destination from 755 to 757
    chmod 757 /usr/lib/galera

# copy our supervisor config file
COPY supervisord.conf /etc/supervisor/conf.d/supervisord.conf

EXPOSE 22
CMD ["/usr/bin/supervisord"]